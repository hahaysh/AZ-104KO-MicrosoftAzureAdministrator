---
lab:
    title: '11 - 모니터링 구현'
    module: '모듈 11 - 모니터링'
---

# 랩 11 - 모니터링 구현


## 랩 시나리오

Azure 가상 머신을 중심으로 Azure 리소스의 성능과 구성에 대한 통찰력을 제공하는 Azure 기능을 평가합니다. 이를 위해 Log Analytics를 비롯한 Azure Monitor의 기능을 살펴보십시오.

## 목표

이 과정에서, 우리는 다음과 같은 실습을 합니다 :

+ 작업 1: 랩 환경 프로비전
+ 작업 2: Azure Log Analytics 작업 영역, Azure Automation 기반 솔루션 생성 및 구성
+ 작업 3: Azure 가상 머신의 기본 모니터링 환경 검토
+ 작업 4: Azure 가상 머신 진단 설정 구성
+ 작업 5: Azure Monitor 기능 검토
+ 작업 6: Azure Log Analytics 기능 검토


## 설명

### 작업 1: 랩 환경 프로비전

이 작업에서는 모니터링 시나리오를 테스트하는 데 사용할 가상 머신을 배포합니다. 

1. [Azure portal](https://portal.azure.com)에 로그인한다. 

1. Azure 포털 오른쪽 위의 아이콘을 클릭하여 **Azure Cloud Shell**을 실행한다.

1. **Bash** 또는 **PowerShell**을 선택하는 프롬프트 창에서 **PowerShell**을 선택한다. 

    >**참고**:  **Cloud Shell**을 처음 실행한 경우, **탑재된 스토리지가 없음** 메시지가 표시됩니다. 이 랩에서 사용하고 있는 구독을 선택하고 **스토리지 만들기**를 클릭하십시오.

1. Cloud Shell 창의 툴바에서 **파일 업로드/다운로드** 아이콘을 선택하고, **업로드**를 클릭하여 **\\Allfiles\\Labs\\11\\az104-11-vm-template.json** 과 **\\Allfiles\\Labs\\11\\az104-11-vm-parameters.json** 파일을 Cloud Shell 홈 디렉토리에 업로드한다. 

1. Cloud Shell 창에서 다음 명령을 실행하여 가상 머신을 호스팅할 리소스 그룹을 생성한다. (`[Azure_region]`을 가상 머신을 배포할 Azure 지역의 이름으로 대체한다):

    >**참고**: **Log Analytics Workspace Region** 목록에 있는 지역을 선택해야 합니다. 목록은 [Workspace mappings documentation](https://docs.microsoft.com/en-us/azure/automation/how-to/region-mappings)에서 확인하십시오.

   ```powershell
   $location = '[Azure_region]'

   $rgName = 'az104-11-rg0'

   New-AzResourceGroup -Name $rgName -Location $location
   ```

1. Cloud Shell 창에서 다음 명령을 실행하여, 업로드한 템플릿과 파라미터 파일을 이용해 첫 번째 가상 네트워크에 가상 머신을 배포한다. 

   ```powershell
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-11-vm-template.json `
      -TemplateParameterFile $HOME/az104-11-vm-parameters.json `
      -AsJob
   ```

1. Cloud Shell 창을 최소화한다.

    >**참고**: 배포가 완료될 때까지 기다리지 않고 다음 작업을 진행하십시오. 배포에는 약 3분 소요됩니다.


### 작업 2: Azure Log Analytics 작업 영역, Azure Automation 기반 솔루션 생성 및 구성

이 작업에서는 Azure Log Analytics 작업 영역 및 Azure Automation 기반 솔루션을 생성하고 구성합니다.

1. Azure 포털에서 **Log Analytics 작업 영역**을 찾아 선택하고, 블레이드에서 **+ 추가**를 클릭한다.

1. 다음 설정을 사용하여 새 Log Analytics 작업 영역을 생성한다. 

    | 설정 | 값 |
    | --- | --- |
    | 인스턴스 이름 | 고유한 이름 |
    | 구독 | 이 랩에서 사용하는 구독의 이름 |
    | 리소스 그룹 | 새로 만들기 **az104-11-rg1** |
    | 영역 | 이전 작업에서 가상 머신을 배포한 Azure 영역의 이름 |
    | 가격 책정 계층 | **종량제** |

    >**참고**: 반드시 이전 작업에서 가상 머신을 배포한 영역과 같은 영역을 사용해야 합니다. 

    >**참고**: 배포가 끝날 때까지 기다리십시오. 배포에는 약 1분 소요됩니다. 

1. Azure 포털에서 **Automation 계정**을 찾아 선택하고, 블레이드에서 **+ 추가**를 클릭한다.

1. **Automation 계정 추가** 블레이드에서 다음 설정을 사용하고 **만들기**를 클릭한다.

    | 설정 | 값 |
    | --- | --- |
    | 이름 | 고유한 이름 |
    | 구독 | 이 랩에서 사용하는 구독의 이름 |
    | 리소스 그룹 | **az104-11-rg1** |
    | 위치 | [Workspace mappings documentation](https://docs.microsoft.com/en-us/azure/automation/how-to/region-mappings) 목록에 있는 Azure 영역의 이름 |
    | Azure 실행 계정 만들기 | **예** |

    >**참고**: 반드시 [Workspace mappings documentation](https://docs.microsoft.com/en-us/azure/automation/how-to/region-mappings) 목록에 있는 Azure 영역을 사용하십시오.

    >**참고**: 배포가 끝날 때까지 기다리십시오. 이 작업은 약 3분 소요됩니다.

1. **Add Automation 계정** 블레이드에서 **새로 고침**을 클릭하여 Automation 계정이 생성된 것을 확인하고 선택한다. 

1. **구성 관리** 섹션에서 **인벤토리**를 클릭한다.

1. **인벤토리** 창의 **Log Analytics 작업 영역** 드롭다운 리스트에서 앞서 생성한 Analytics 작업 영역을 선택하고, **사용**을 클릭한다.

    >**참고**: Log Analytics 솔루션을 설치할 때까지 기다리십시오. 이 작업은 약 3분 소요됩니다.

    >**참고**: **변경 내용 추적** 솔루션은 자동으로 설치됩니다. 

1. Automation 계정 블레이드의 **업데이트 관리**를 선택하고 **사용**을 클릭한다.

    >**참고**: 설치가 완료될 때까지 기다리십시오. 이 작업은 약 5분 소요됩니다.


### 작업 3: Azure 가상 머신 기본 모니터링 환경 검토

이 작업에서는 Azure 가상 머신의 기본 모니터링 환경을 검토합니다. 

1. Azure 포털에서 **가상 머신**을 찾아 선택하고, 목록에서 **az104-11-vm0**를 클릭한다.

1. **az104-11-vm0** 블레이드에서 **모니터링** 섹션의 **메트릭**을 클릭한다.

1. **az104-11-vm0 - 메트릭** 블레이드 기본 차트의 **메트릭 네임스페이스**에 **가상 머신 호스트**만 사용할 수 있는 것을 확인한다.

    >**참고**: 이는 게스트 레벨 진단 설정이 아직 구성되지 않았기 때문입니다.

1. **메트릭** 드롭다운 리스트에서 이용 가능한 메트릭 목록을 검토한다.

    >**참고**: 목록은 게스트 레벨 메트릭에 액세스하지 않고도 가상 시스템 호스트에서 수집할 수 있는 다양한 CPU, 디스크 및 네트워크 관련 메트릭을 포함합니다.

1. **메트릭** 드롭다운 리스트에서 **Percentage CPU**를 선택한다. **집계** 드롭다운 리스트에서 **평균**을 선택하고 결과를 확인한다.


### 작업 4: Azure 가상 머신 진단 설정 구성

이 작업에서는 Auzure 가상 머신 진단 설정을 구성합니다.

1. **az104-11-vm0** 블레이드에서 **모니터링** 섹션의 **진단 설정**을 클릭한다.

1. **개요** 탭에서 **게스트 수준 모니터링 사용**을 클릭한다.

    >**참고**: 설정이 완료될 때까지 기다리십시오. 이 작업은 약 3분 소요됩니다.

1. **성능 카운터** 탭에서 사용 가능한 카운터를 검토한다. 

    >**참고**: 기본적으로 메모리, 디스크 및 네트워크 카운터를 이용할 수 있습니다. **사용자 지정** 을 클릭하여 자세한 목록을 확인하십시오.

1. **로그** 탭에서 사용 가능한 이벤트 로그 옵션을 검토한다. 

    >**참고**: 기본적으로 로그 모음은 애플리케이션과 시스템으로부터 위험, 오류, 경고 로그를 수집하며, 보안 로그에서 감사 오류 항목을 수집합니다. 여기서도 **사용자 지정** 으로 전환하여 자세한 구성 설정을 확인하십시오.

1. **az104-11-vm0** 가상 머신 블레이드의 **모니터링** 섹션에서 **로그**를 클릭한다. 

1. **az104-11-vm0 - 로그** 블레이드의 **Log Analytics 작업 영역 선택** 드롭다운 목록에서 이전 작업에서 만들었던 작업 영역을 선택하고 **사용**을 클릭한다.

    >**참고**: 배포가 끝날 때까지 기다리지 않고 다음 단계를 진행하십시오. 이 작업은 약 5분 소요됩니다.

1. **az104-11-vm0 - 로그** 블레이드에서 **모니터링** 섹션의 **메트릭**을 클릭한다.

1. **az104-11-vm0 - 메트릭** 블레이드의 기본 차트에서, 이번에는 **메트릭 네임스페이스** 드롭다운 리스트에 **가상 머신 호스트**와 **게스트(클래식)** 이 있는 것을 확인한다. 

    >**참고**: 게스트 레벨 진단 설정을 허용했기 때문입니다.

1. **메트릭** 드롭다운 리스트에서 사용할 수 있는 메트릭의 목록을 확인한다.

    >**참고**: 이 목록에는 호스트 수준 모니터링에만 의존하는 경우엔 사용할 수 없는 게스트 수준 메트릭이 포함되어 있습니다.

1. **메트릭** 드롭다운 리스트에서 **Memory\Available Bytes**를 선택하고, **집계** 드롭다운 리스트에서 **평균**을 선택한 뒤, 결과로 나타나는 차트를 확인한다.  


### 작업 5: Azure 모니터 기능 검토

1. Azure 포털에서 **모니터**를 찾아 선택하고, **모니터 - 개요** 블레이드에서 **메트릭**을 클릭한다.

1. 차트의 **리소스** 드롭다운 리스트에서 **+ 리소스 선택**을 클릭한다.

1. **범위 선택** 블레이드의 **찾아보기** 탭에서 **az104-11-rg0** 리소스 그룹 아래 **az104-11-vm0**을 선택하고, **적용**을 클릭한다.

    >**참고**: 이를 통해 **az104-11-vm0 - 메트릭** 블레이드에서 사용할 수 있는 것과 동일한 보기 및 옵션을 제공합니다.

1. **모니터 - 메트릭** 블레이드에서 **새로운 경고 규칙**을 클릭한다.

    >**참고**: 게스트(클래식) 메트릭 네임스페이스의 메트릭에는 경고 규칙 생성이 지원되지 않습니다. 이 작업은 Azure Resource Manager 템플릿을 사용하여 수행할 수 있습니다. 자세한 내용은 다음 문서를 참고하십시오. [Send Guest OS metrics to the Azure Monitor metric store using a Resource Manager template for a Windows virtual machine](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/collect-custom-metrics-guestos-resource-manager-vm)

1. **경고 규칙 만들기** 블레이드에서 **리소스** 섹션의 **리소스 선택**을 클릭한다. **리소스 선택** 블레이드에서 **az104-11-vm0** 가상 머신을 찾아 체크박스를 선택하고, **완료**를 클릭한다. 

1. **조건** 섹션에서 **조건 선택**을 클릭한다. 

1. **신호 논리 구성** 블레이드에서 신호 목록 중 **Percentage CPU**를 선택하고, **경고 논리** 섹션에서 다음 설정을 사용한 후 **완료**를 클릭한다. (다른 값은 기본 설정을 사용한다) 

    | 설정 | 값 |
    | --- | --- |
    | 임계값 | **정적** |
    | 연산자 | **보다 큼** |
    | 집계 유형 | **평균** |
    | 임계값 | **2** |
    | 집계 세분성(기간) | **1분** |
    | 평가 빈도 | **1분마다** |

1.  **경고 규칙 만들기** 블레이드의 **작업 그룹 (선택 사항)** 섹션에서 **작업 그룹 선택**을 클릭한다.

1. **작업 그룹 만들기** 블레이드에서 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다) 

    | 설정 | 값 |
    | --- | --- |
    | 작업 그룹 이름 | **az104-11-ag1** |
    | 표시 이름 | **az104-11-ag1** |
    | 구독 | 이 랩에서 사용하는 Azure 구독의 이름 |
    | 리소스 그룹 | **az104-11-rg1** |

1. **작업 그룹 만들기** 블레이드의 **작업** 탭에서 다음 설정을 사용한다.

    | 설정 | 값 |
    | --- | --- |
    | 작업 유형 | **이메일/SMS 메시지/푸시/음성** |
    | 이름 | **az104-11-ag1 email** |

1. **이메일/SMS 메시지/푸시/음성** 블레이드에서 **이메일** 체크박스를 선택하고, 이메일 주소를 입력한다. 다른 값은 기본 설정으로 두고 **확인**을 클릭한 뒤, **작업 그룹 만들기** 블레이드로 돌아와 **만들기**를 클릭한다.

1. **경고 규칙 만들기** 블레이드로 돌아가 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다) 

    | 설정 | 값 |
    | --- | --- |
    | 경고 규칙 이름 | **CPU Percentage above the test threshold** |
    | 설명 | **CPU Percentage above the test threshold** |
    | 심각도 | **Sev 3** |
    | 경고 규칙을 만들면 바로 사용 | **Yes** |

1. **경고 규칙 만들기**를 클릭하고 블레이드를 닫는다. 

    >**참고**: 메트릭 경고 규칙을 활성화하는 데 최대 10분 소요됩니다.

1. Azure 포털에서 **가상 머신**을 찾아 선택하고, **az104-11-vm0**을 클릭한다.

1. **az104-11-vm0** 블레이드에서 **연결**을 클릭하고, **RDP**를 선택한다. **RDP를 사용하여 연결** 블레이드에서 **RDP 파일 다운로드**를 클릭하고 원격 데스크톱 세션을 시작한다.

    >**참고**: 이 단계는 Windows 컴퓨터에서 원격 데스크톱을 통해 연결하는 것을 말합니다. Mac에서는 Mac App Store에서 Remote Desktop Client를 사용할 수 있으며, Linux 컴퓨터에서는 오픈 소스 RDP 클라이언트 소프트웨어를 사용할 수 있습니다.

    >**참고**: 가상 머신에 연결할 때 생기는 경고 메시지는 무시할 수 있습니다.

1. 원격 데스크톱에 연결되면 **Student** 계정과 **Pa55w.rd1234** 패스워드를 사용하여 로그인한다.

1. 원격 데스크톱 세션에서 **Start**를 클릭하고, **Windows System** 폴더에서 **Command Prompt** 를 실행한다.

1. 명령 프롬프트 창에서 다음 명령을 실행하여 가상 컴퓨터에 부하를 일으킨다.

   ```
   for /l %a in (0,0,1) do echo a
   ```

    >**참고**: 이 작업은 무한 루프를 시작하여, CPU 사용량이 새로운 경고 규칙의 임계값을 초과하도록 유도합니다.

1. 원격 데스크톱 세션을 열어두고, 랩 컴퓨터의 Azure 포털로 돌아간다.

1. Azure 포털에서 **모니터** 블레이드로 돌아가 **경고**를 클릭한다.

1. **Sev 3** 경고를 확인하고 클릭한다.

    >**참고**: 결과가 나타날 때까지 몇 분 기다렸다가 **새로 고침** 하십시오. 

1. **모든 경고** 블레이드에서 생성된 경고를 확인한다. 


### 작업 6: Azure Log Analytics 기능 검토

1. Azure 포털에서 **모니터** 블레이드로 돌아가 **로그**를 클릭한다. 

    >**참고**: Log Analytics에 최초로 접근하는 경우라면, **시작**을 클릭합니다.

1. **범위 선택** 블레이드에서 **az104-11-rg0** 리소스 그룹을 확장하여 **a104-11-vm0**을 선택하고 **적용**을 클릭한다.

1. 툴바에서 **예제 쿼리**를 클릭한다. **예제 쿼리** 창에서 **Virtual machine available memory**를 찾아 **실행**을 클릭한다.

1. 결과 차트를 검토하고, 다음 내용을 포함하는 줄을 삭제한다. 

   ```
   | where TimeGenerated > ago(1h)
   ```

    >**참고**: 그 결과, 도구 모음의 **시간 범위** 항목이 **쿼리설정**에서 **지난 24시간**으로 변경됩니다.

1. 쿼리를 재실행하고 결과 차트를 검토한다.

1. **새 쿼리 1** 탭의 **테이블** 탭에서 **Virtual machines** 테이블의 목록을 검토한다.

    >**참고**: 몇몇 테이블의 이름은 이 랩의 이전 작업에서 설치한 솔루션의 이름과 일치합니다.

1. 마우스를 **VMComputer** 항목 위로 가져가서 **데이터 미리보기** 아이콘을 클릭한다.

1. 사용 가능한 데이터가 있는 경우, **쿼리 편집기에서 보기**를 클릭한다.

    >**참고**: 업데이트 데이터를 사용할 수 있으려면 몇 분 정도 기다리십시오.

1. 쿼리 결과에 표시된 출력을 검토한다.

1. 툴바에서 **예제 쿼리**를 클릭하고, **예제 쿼리** 창에서 **Virtual machine free disk space**를 선택하고 **실행**을 클릭한다.


### 리소스 삭제

   >**참고**: 사용하지 않는 새로 생성된 Azure 리소스를 제거하십시오. 사용하지 않는 리소스를 제거해야 예상치 못한 비용이 발생하지 않습니다.

1. Azure 포털에서 **Cloud Shell**의 **PowerShell** 세션을 시작한다.

1. 다음 명령을 실행하여 이 모듈의 실습에서 생성된 모든 리소스 그룹을 나열한다.

   ```powershell
   Get-AzResourceGroup -Name 'az104-11*'
   ```

1. 다음 명령을 실행하여 이 모듈의 실습에서 생성한 모든 리소스 그룹을 삭제한다.

   ```powershell
   Get-AzResourceGroup -Name 'az104-11*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**참고**: 이 명령은 비동기적으로 실행되므로( --nowait 매개 변수로 결정됨) 동일한 PowerShell 세션 내에서 즉시 다른 PowerShell 명령을 실행할 수 있지만, 리소스 그룹이 실제로 제거되기까지는 몇 분 정도 소요됩니다.


### 요약

이 랩에서 우리는

- 랩 환경을 프로비전 했습니다.
- Azure Log Analytics 작업 영역과 Azure Automation 기반 솔루션을 생성 및 구성했습니다.
- Azure 가상 머신의 기본 모니터링 환경을 검토했습니다.
- Azure 가상 머신 진단 설정을 구성했습니다.
- Azure Monitor 기능을 검토했습니다.
- Azure Log Analytics 기능을 검토했습니다.

