---
lab:
    title: '08 - 가상 머신 관리'
    module: '모듈 08 - 가상 머신'
---

# 랩 08 - 가상 머신 관리


## 랩 시나리오

Azure 가상 머신을 배포하고 구성하기 위한 다양한 옵션을 식별하는 작업을 수행합니다. 첫째, Azure 가상 머신을 사용할 때 구현할 수 있는 다양한 컴퓨팅 및 스토리지 복원력과 확장성 옵션을 결정해야 합니다. 다음으로 Azure 가상 머신 확장 집합을 사용할 때 이용할 수 있는 컴퓨팅 및 스토리지 복원력 및 확장성 옵션을 조사합니다. 또한 Azure Virtual Machine Custom Script 확장 기능을 사용하여 가상 머신 및 가상 머신 확장 집합을 자동으로 구성하는 기능도 살펴보십시오.


## 목표

이 과정에서, 우리는 다음과 같은 실습을 합니다 :

+ 작업 1: Azure 포털과 Azure 리소스 매니저 템플릿을 사용하여 가상 머신을 배포
+ 작업 2: 가상 머신 확장 기능을 이용하여 Azure 가상 머신 설정
+ 작업 3: Azure 가상 머신을 위한 컴퓨트와 스토리지 확장
+ 작업 4: Azure 포털을 사용하여 Azure 가상 머신 확장 집합 배포
+ 작업 5: 가상 머신 확장 기능을 사용하여 Azure 가상 머신 확장 집합 구성
+ 작업 6: Azure 가상 머신 확장 집합을 위한 컴퓨트와 스토리지 확장 (선택 사항)


## 설명

### 작업 1: Azure 포털과 Azure 리소스 매니저 템플릿을 사용하여 가상 머신을 배포

이 작업에서는 Azure 포털과 Azure 리소스 매니저 템플릿을 사용하여 서로 다른 가용 영역에 Azure 가상 머신을 배포합니다.

1. [Azure portal](http://portal.azure.com)에 로그인한다.

1. Azure 포털에서 **가상 머신**을 찾아 선택하고 **가상 머신** 블레이드에서 **+ 추가**를 클릭한다.

1. **가상 머신 만들기** 블레이드의 **기본 사항** 탭에서 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 | 
    | --- | --- |
    | 구독 | 이 랩에서 사용할 Azure 구독의 이름 |
    | 리소스 그룹 | 새로만들기 **az104-08-rg01** |
    | 가상 머신 이름 | **az104-08-vm0** |
    | 지역 | 가용성 영역을 지원하는 지역 이름 선택 | 
    | 가용성 옵션 | **가용성 영역** |
    | 가용성 영역 | **1** |
    | 이미지 | **Windows Server 2019 Datacenter** |
    | Azure Spot 인스턴스 | **아니요** |
    | 크기 | **표준 D2s v3** |
    | 사용자 이름 | **Student** |
    | 암호 | **Pa55w.rd1234** |
    | 공용 인바운드 포트 | **없음** |
    | 이미 Windows Server 라이선스가 있나요? | **아니요** |

1. **다음: 디스크 >** 를 클릭하고 **가상 머신 만들기** 블레이드의 **디스크** 탭에 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 | 
    | --- | --- |
    | OS 디스크 유형 | **표준 HDD** |
    | Ultra Disk 호환성 사용 | **아니요** |

1. **다음: 네트워킹 >** 을 클릭하고 **가상 머신 만들기** 블레이드의 **네트워킹** 탭에서 **가상 네트워크** 아래 **새로 만들기**를 클릭한다. 

1. **가상 네트워크 만들기** 블레이드에서 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 | 
    | --- | --- |
    | 이름 | **az104-08-rg01-vnet** |
    | 주소 공간 | **10.80.0.0/20** |
    | 서브넷 이름 | **subnet0** |
    | 서브넷 주소 범위 | **10.80.0.0/24** |
 
1. **확인**을 누르고 **가상 머신 만들기** 블레이드의 **네트워킹** 탭으로 돌아가서 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 | 
    | --- | --- |
    | 공용 IP | **없음** |
    | NIC 네트워크 보안 그룹 | **없음** |
    | 가속화된 네트워킹 | **끄기** |
    | 기존 부하 분산 솔루션 뒤에 이 가상 머신을 배치하시겠습니까? | **아니요** |

1. **다음: 관리 >** 를 클릭하고 **가상 머신 만들기** 블레이드의 **관리** 탭에서 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다) 

    | 설정 | 값 | 
    | --- | --- |
    | 부트 진단 | **끄기** |

1. **다음: 고급 >** 을 클릭하고 가능한 설정을 검토한 후, 기본 값으로 두고 **검토 + 만들기**를 클릭한다. 

1. 유효성 검사를 통과하면 **만들기**를 클릭한다.

1. 배포 블레이드에서 **템플릿**을 클릭한다.

1. 배포중인 템플릿을 검토하고, **배포**를 클릭한다.

    >**참고**: 이 옵션을 사용해 같은 구성의 두 번째 가상 머신을 배포합니다. (가용성 영역 설정 제외)

1. **사용자 지정 배포** 블레이드에서 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 | 
    | --- | --- |
    | 리소스 그룹 | **az104-08-rg01** |
    | 네트워크 인터페이스 이름 | **az104-08-vm1-nic1** |
    | 가상 머신 이름 | **az104-08-vm1** |
    | 관리자 계정 | **Student** |
    | 암호 | **Pa55w.rd1234** |
    | 영역 | **2** |

    >**참고**: 템플릿을 사용하여 배포하는 고유 리소스의 속성에 해당하는 매개 변수를 수정해야 합니다. 이는 가상 머신과 해당 네트워크 인터페이스를 포함합니다. 또한 두 개의 가상 머신을 영역 중복으로 배포하려면 다른 가용성 영역을 지정하십시오.

1. **위에 명시된 사용 약관에 동의함**에 체크하고 **구매**를 클릭한다.

    >**참고**: 다음 작업을 시작하기 전에 가상 머신 배포가 모두 끝날 때까지 기다리십시오. 이 작업은 약 5분 소요됩니다.


### 작업 2: 가상 머신 확장 기능을 이용하여 Azure 가상 머신 설정

이 작업에서는 사용자 지정 스크립트 가상 머신 확장 기능을 사용하여 이전 작업에서 배포한 두 Azure 가상 머신에  Windows Web Server role을 설치합니다.

1. Azure 포털에서 **가상 머신**을 찾아 클릭하고, **가상 머신** 블레이드에서 **az104-08-vm0**을 클릭한다.

1. **az104-08-vm0** 가상 머신 블레이드에서 **설정** 섹션의 **확장**을 선택하고, **+ 추가**를 클릭한다.

1. **새 리소스** 블레이드에서 **Custom Script Extension**을 선택하고, **만들기**를 클릭한다.

1. **확장 설치** 블레이드에서 **\\Allfiles\\Labs\\08**의 **az104-08-install_IIS.ps1** 스크립트를 업로드하고 **확인**을 클릭한다.

1. Azure 포털에서 **가상 머신**을 찾아 **az104-08-vm1**을 클릭한다.

1. **az104-08-vm1** 블레이드에서 **설정** 섹션의 **템플릿 내보내기**를 클릭한다.

1. **az104-08-vm1 - 템플릿 내보내기** 블레이드에서 **배포**를 클릭한다. 

1. **사용자 지정 배포** 블레이드에서 **템플릿 편집**을 클릭한다.

1. **템플릿 편집** 블레이드에서 **20**번째 줄에 다음 내용을 추가한다. (`    "resources": [` 줄 바로 아래)

   ```json
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "az104-08-vm1/customScriptExtension",
            "apiVersion": "2018-06-01",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "az104-08-vm1"
            ],
            "properties": {
                "publisher": "Microsoft.Compute",
                "type": "CustomScriptExtension",
                "typeHandlerVersion": "1.7",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "commandToExecute": "powershell.exe Install-WindowsFeature -name Web-Server -IncludeManagementTools && powershell.exe remove-item 'C:\\inetpub\\wwwroot\\iisstart.htm' && powershell.exe Add-Content -Path 'C:\\inetpub\\wwwroot\\iisstart.htm' -Value $('Hello World from ' + $env:computername)"
              }
            }
        },   
   ```

    >**참고**: 템플릿의 해당 섹션은 Azure PowerShell을 통해 첫 번째 가상 머신에 이전에 배포한 것과 동일한 Azure 가상 머신 사용자 지정 스크립트 확장을 정의합니다.

1. **저장**하고, **사용자 지정 배포** 블레이드에서 **위에 명시된 사용 약관에 동의함**에 체크하고 **구매**를 클릭한다.

    >**참고**: **템플릿에 있는 하나 이상의 리소스가 지원하지 않는 위치에 리소스 그룹이 있습니다 다른 리소스 그룹을 선택하세요** 메시지는 이 작업에서 무시하십시오. 

    >**참고**: 템플릿 배포 작업이 끝날 때까지 기다리십시오. **az104-08-vm0** 과 **az104-08-vm1** 가상 머신의 **확장** 블레이드에서 배포 과정을 모니터링할 수 있습니다. 이 작업은 3분 미만 소요됩니다.

1. **az104-08-vm1**블레이드의 **작업** 섹션에서 **실행 명령**을 클릭하고 **RunPowerShellScript**를 선택하여 Custom Script extension 구성의 결과를 확인하십시오.

1. **실행 명령 스크립트** 블레이드에서 다음 명령을 입력하고 **실행**을 클릭하여 **az104-08-vm0**에 호스팅된 웹 사이트에 접근한다.

   ```powershell
   Invoke-WebRequest -URI http://10.80.0.4 -UseBasicParsing
   ```

    >**참고**: The **-UseBasicParsing** 파라미터는 cmdlet 실행을 완료하기 위해 Internet Explorer(인터넷 익스플로러)에 대한 종속성을 제거합니다.

    >**참고**: **az104-08-vm0**에 연결하고 `Invoke-WebRequest -URI http://10.80.0.5`를 실행하여 **az104-08-vm1**에 호스팅된 웹 사이트에 접근할 수도 있습니다. 


### 작업 3: Azure 가상 머신을 위한 컴퓨트와 스토리지 확장

이 작업에서는 Azure 가상 머신의 크기를 변경하여 컴퓨팅을 확장하고. 데이터 디스크를 연결 및 구성하여 가상 머신의 스토리지를 확장합니다.

1. Azure 포털 **가상 머신** 블레이드에서 **az104-08-vm0**을 클릭한다.

1. **az104-08-vm0** 가상 머신 블레이드에서 **크기**를 클릭하고 가상 머신 크기를 **표준 DS1_v2**로 조정한다.

    >**참고**: **표준 DS1_v2**을 사용할 수 없다면 다른 크기를 선택하십시오. 

1. **az104-08-vm0** 블레이드에서 **디스크**를 클릭하고, **+ 데이터 디스크 추가**를 클릭한다. **이름** 드롭 다운 리스트에서 **디스크 생성**을 클릭한다.

1. 다음 설정을 사용해 관리 디스크를 생성한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 | 
    | --- | --- |
    | 디스크 이름 | **az104-08-vm0-datadisk-0** |
    | 원본 유형 | **없음** |
    | 스토리지 유형 | **프리미엄 SSD** |
    | 크기 | **1024 GiB** |


1. **az104-08-vm0 - 디스크** 블레이드에서 **+ 데이터 디스크 추가** 를 클릭하고, **이름** 드롭다운 리스트에서 **디스크 생성**을 클릭한다.

1. 다음 설정을 사용해 관리 디스크를 생성한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 | 
    | --- | --- |
    | 디스크 이름 | **az104-08-vm0-datadisk-1** |
    | 원본 유형 | **없음** |
    | 스토리지 유형 | **프리미엄 SSD** |
    | 크기 | **1024 GiB** |

1. **az104-08-vm0 - 디스크** 블레이드에서 **저장**을 클릭한다.

1. **az104-08-vm0** 블레이드에서 **작업** 섹션의 **실행 명령**을 클릭한다. 목록에서 **RunPowerShellScript**을 클릭한다.

1. **실행 명령 스크립트** 블레이드에서 다음 명령을 입력하고 **실행**을 클릭하여 단순한 레이아웃과 고정 프로비저닝을 사용하여 새로 연결된 두 개의 디스크로 구성된 Z 드라이브를 생성한다. 

   ```powershell
   New-StoragePool -FriendlyName storagepool1 -StorageSubsystemFriendlyName "Windows Storage*" -PhysicalDisks (Get-PhysicalDisk -CanPool $true)

   New-VirtualDisk -StoragePoolFriendlyName storagepool1 -FriendlyName virtualdisk1 -Size 2046GB -ResiliencySettingName Simple -ProvisioningType Fixed

   Initialize-Disk -VirtualDisk (Get-VirtualDisk -FriendlyName virtualdisk1)

   New-Partition -DiskNumber 4 -UseMaximumSize -DriveLetter Z
   ```

    > **참고**: **스크립트 실행 완료** 확인 메시지를 기다리십시오.

1. Azure 포털 **가상 머신** 블레이드에서 **az104-08-vm1**을 클릭한다.

1. **az104-08-vm1** 블레이드의 **설정** 섹션에서 **템플릿 내보내기**를 클릭한다.

1. **az104-08-vm1 - 템플릿 내보내기** 블레이드에서 **배포**를 클릭한다. 

1. **사용자 지정 배포** 블레이드에서 **템플릿 편집**을 클릭한다.

1. **템플릿 편집** 블레이드에서 스크립트의 **30**번째 줄 (`                    "vmSize": "Standard_D2s_v3"`)을 다음 내용으로 교체한다. 

   ```json
                    "vmSize": "Standard_DS1_v2"

   ```

    >**참고**: 해당 템플릿 섹션은 Azure 포털을 통해 구성한 첫 번째 가상 머신의 크기와 동일한 가상 머신 크기를 정의합니다.

1. **템플릿 편집** 블레이드에서 스크립트의 **49**번째 줄 (`                    "dataDisks": [ ]`)을 다음 내용으로 교체한다.

   ```json
                    "dataDisks": [
                      {
                        "lun": 0,
                        "name": "az104-08-vm1-datadisk0",
                        "diskSizeGB": "1024",
                        "caching": "ReadOnly",
                        "createOption": "Empty"
                      },
                      {
                        "lun": 1,
                        "name": "az104-08-vm1-datadisk1",
                        "diskSizeGB": "1024",
                        "caching": "ReadOnly",
                        "createOption": "Empty"
                      }
                    ]
   ```

    >**참고**: 템플릿의 해당 섹션은 **az104-08-vm1**에 연결된 두 관리 디스크를 생성합니다. Azure 포털을 통한 첫 번째 가상 머신의 스토리지 구성과 유사한 작업입니다.  

1. **저장**하고 **사용자 지정 배포** 블레이드로 돌아와 **위에 명시된 사용 약관에 동의함**에 체크하고 **구매**를 클릭한다.

    >**참고**: **템플릿에 있는 하나 이상의 리소스가 지원하지 않는 위치에 리소스 그룹이 있습니다 다른 리소스 그룹을 선택하세요** 메시지는 이 작업에서 무시하십시오. 

    >템플릿 배포 작업이 끝날 때까지 기다리십시오.  **az104-08-vm1** 가상 머신의 **확장** 블레이드에서 배포 과정을 모니터링할 수 있습니다. 이 작업은 3분 미만 소요됩니다.

1. **az104-08-vm1** 블레이드의 **작업** 섹션에서 **실행 명령**을 선택하고, 목록에서 **RunPowerShellScript**을 클릭한다.

1. **실행 명령 스크립트** 블레이드에서 다음 명령을 입력하고 **실행**을 클릭하여 단순한 레이아웃과 고정 프로비저닝을 사용하여 새로 연결된 두 개의 디스크로 구성된 Z 드라이브를 생성한다. 

   ```powershell
   New-StoragePool -FriendlyName storagepool1 -StorageSubsystemFriendlyName "Windows Storage*" -PhysicalDisks (Get-PhysicalDisk -CanPool $true)

   New-VirtualDisk -StoragePoolFriendlyName storagepool1 -FriendlyName virtualdisk1 -Size 2046GB -ResiliencySettingName Simple -ProvisioningType Fixed

   Initialize-Disk -VirtualDisk (Get-VirtualDisk -FriendlyName virtualdisk1)

   New-Partition -DiskNumber 4 -UseMaximumSize -DriveLetter Z
   ```
>**참고** : **스크립트 실행 완료** 확인 메시지를 기다리십시오.


### 작업 4: Azure 포털을 사용하여 Azure 가상 머신 확장 집합 배포

이 작업에서는 Azure 포털을 사용하여 가용성 영역에 가상 머신 확장 집합을 배포합니다.

1. Azure 포털에서 **Virtual machine scale sets**을 찾아 선택하고, **Virtual machine scale sets** 블레이드에서 **+ 추가**를 클릭한다.

1. **가상 머신 확장 집합 만들기** 블레이드의 **기본 사항** 탭에서 다음 설정을 사용하여 구성하고, **다음 : 디스크 >** 를 클릭한다. (다른 값은 기본 설정을 사용한다) 

    | 설정 | 값 | 
    | --- | --- |
    | 구독 | 이 랩에서 사용하는 구독 |    
    | 리소스 그룹 | 새로만들기 **az104-08-rg02** |    
    | 가상 머신 확장 집합 이름 | **az10408vmss0** |
    | 지역 | 가용성 영역을 지원하는 지역 | 
    | 가용성 영역 | **영역 1, 2, 3** |
    | 이미지 | **Windows Server 2016 Datacenter** |
    | Azure Spot 인스턴스 | **No** |
    | 크기 | **표준 D2s_v3** |    
    | 관리자 계정 | **Student** |
    | 암호 | **Pa55w.rd1234** |
    | 이미 Windows Server 라이선스가 있나요? | **No** |

    >**참고**: 가용성 영역에 Windows 가상 머신 배포를 지원하는 지역 목록은 [What are Availability Zones in Azure?](https://docs.microsoft.com/en-us/azure/availability-zones/az-overview) 을 참고하십시오

1. **디스크** 탭에서 **가상 머신 확장 집합 만들기** 블레이드의 **디스크** 탭에서 기본 설정을 검토하고 **다음 : 네트워킹 >** 을 클릭한다.

1. **가상 머신 확장 집합 만들기** 블레이드의 **네트워킹** 탭에서 **가상 네트워크 만들기** 링크를 클릭하고 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다) 

    | 설정 | 값 | 
    | --- | --- |
    | 이름 | **az104-08-rg02-vnet** |
    | 주소 범위 | **10.82.0.0/20** |
    | 서브넷 이름 | **subnet0** |
    | 서브넷 주소 범위 | **10.82.0.0/24** |
 
    >**참고**: 새로운 가상 머신을 만들고 **가상 머신 확장 집합 만들기** 블레이드의 **네트워킹** 탭으로 돌아가면, **가상 네트워크** 값은 **az104-08-rg02-vnet**으로 자동 설정됩니다.

1. **가상 머신 확장 집합 만들기** 블레이드의 **네트워킹**탭으로 돌아와서 네트워크 인터페이스 목록 오른쪽의 **네트워크 인터페이스 편집** 아이콘을 클릭한다.  

1. **네트워크 인터페이스 편집** 블레이드의 **NIC 네트워크 보안 그룹** 섹션에서 **고급**을 클릭하고 **네트워크 보안 그룹 구성** 밑의 **새로만들기**를 클릭한다. 

1. **네트워크 보안 그룹 만들기** 블레이드에서 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다) 

    | 설정 | 값 | 
    | --- | --- |
    | 이름 | **az10408vmss0-nsg** |

1. **인바운드 규칙 추가**를 클릭하고 다음 설정을 사용하여 인바운드 보안 규칙을 추가한다. (다른 값은 기본 설정을 사용한다) 

    | 설정 | 값 | 
    | --- | --- |
    | 소스 | **Any** |
    | 원본 포트 범위 | **\*** |
    | 대상 주소 | **Any** |
    | 대상 포트 범위 | **80** |
    | 프로토콜 | **TCP** |
    | 작업 | **Allow** |
    | 우선순위 | **1010** | 
    | 이름 | **custom-allow-http** |

1. **추가**를 클릭하고 **네트워크 보안 그룹 만들기** 블레이드에서 **확인**을 클릭한다.

1. **네트워크 인터페이스 편집** 블레이드에서 **공용 IP 주소** 섹션을 **사용**으로 설정하고, **확인**을 클릭한다.

1. **가상 머신 확장 집합 만들기** 블레이드의 **네트워킹**탭으로 돌아와서 다음 설정을 사용하고 **다음 : 확장 중 >** 을 클릭한다. 

    | 설정 | 값 | 
    | --- | --- |
    | 부하 분산 장치 사용 | **예** |
    | 부하 분산 옵션 | **Azure load balancer** |
    | 부하 분산 장치 선택 | **(new) az10408vmss0-lb** |
    | 백 엔드 풀 선택 | **(new) bepool** |
    
1.  **가상 머신 확장 집합 만들기** 블레이드의 **확장 중** 탭에서 다음 설정을 사용하고, **다음 : 관리 >** 를 클릭한다.

    | 설정 | 값 | 
    | --- | --- |
    | 초기 인스턴스 수 | **2** |
    | 크기 조정 정책 | **수동** |

1. **가상 머신 확장 집합 만들기** 블레이드의 **관리** 탭에서 다음 설정을 사용하고, **다음 : 상태 >** 를 클릭한다.

    | 설정 | 값 | 
    | --- | --- |
    | 부트 진단 | **끄기** |
    
1. **가상 머신 확장 집합 만들기** 블레이드의 **상태** 탭에서 기본 설정을 검토하고 **다음 : 고급 >** 을 클릭한다. 

1.  **가상 머신 확장 집합 만들기** 블레이드의 **고급** 탭에서 다음 설정을 사용하고, **검토 : 만들기 >** 를 클릭한다. 

    | 설정 | 값 | 
    | --- | --- |
    | 분산 알고리즘 | **고정 분산(영역에서 권장되지 않음)** |

    >**참고**: **최대 분산** 설정은 현재 작동하지 않음. 

1. **가상 머신 확장 집합 만들기** 블레이드의 **검토 + 만들기** 탭에서 유효성 검사 통과를 확인하고 **만들기**를 클릭한다.

    >**참고**: 가상 머신 배포가 완료될 때까지 기다리십시오. 이 작업은 약 5분 소요됩니다. 

### 작업 5: 가상 머신 확장 기능을 사용하여 Azure 가상 머신 확장 집합 구성

이 작업에서는 사용자 지정 스크립트 가상 머신 확장을 사용하여 이전 작업에서 배포한 Azure 가상 머신 확장 집합의 인스턴스에 Windows Server Web Server role을 설치합니다.


1. Azure 포털에서 **Virtual machine scale sets** 블레이드를 새로고침하고 **az10408vmss0**를 클릭한다. 

1. **az10408vmss0** 블레이드에서 **확장**을 선택하고, **+ 추가**를 클릭한다.

1. **새 리소스** 블레이드에서 **Custom Script Extension**을 선택하고, **만들기**를 클릭한다.

1. **확장 설치** 블레이드에서 **\\Allfiles\\Labs\\08**의 **az104-08-install_IIS.ps1**를 업로드하고, **확인**을 클릭한다.

    >**참고**: 다음 단계를 진행하기 전에 확장 설치가 완료될 때까지 기다리십시오. 

1. **az10408vmss0** 블레이드 **설정** 섹션의 **인스턴스**를 클릭한다. 가상머신 확장 집합의 두 인스턴스를 선택하고 **업그레이드**를 클릭한다. 확인 창이 뜨면 **예**를 클릭한다. 

    >**참고**: 다음 단계를 진행하기 전에 업그레이드가 완료될 때까지 기다리십시오.

1. Azure 포털에서 **부하 분산 장치**를 검색하고 선택한다. 목록에서 **az10408vmss0lb**를 클릭한다. 

1. **az10408vmss0lb** 블레이드에서 부하 분산 장치의 프론트엔드에 할당된 **공용 IP 주소** 값을 기록해둔다. 브라우저 창을 띄우고, IP 주소로 접속한다. 

    >**참고**: 브라우저 페이지에 Azure 가상 머신 확장 집합 **az10408vmss0**의 인스턴스 이름이 나타나는 것을 확인하십시오.


### 작업 6: Azure 가상 머신 확장 집합을 위한 컴퓨트와 스토리지 확장

이 작업에서는 가상 머신 확장 집합 인스턴스의 크기를 바꾸고 자동확장 설정을 구성하고 디스크를 연결합니다.

1. Auzre 포털의 **az10408vmss0** 블레이드에서 **크기**를 클릭한다. 

1. 사용할 수 있는 크기 목록에서 **표준 DS1_v2**를 선택하고 **크기 조정**을 클릭한다.

1. **설정** 섹션의 **인스턴스**를 클릭한다. 가상머신 확장 집합의 두 인스턴스를 선택하고 **업그레이드**를 클릭한다. 확인 창이 뜨면 **예**를 클릭한다. 

1. 인스턴스 목록에서 첫 번째 인스턴스를 클릭하고, 확장 집합 인스턴스 블레이드에서 **위치**를 확인한다. (해당 위치는 Azure 가상 머신 확장 집합을 배포한 대상 Azure 영역의 영역 중 하나여야 한다) 

1. **az10408vmss0 - 인스턴스** 블레이드로 돌아간다. 인스턴스 목록에서 두 번째 인스턴스를 클릭하고, 확장 집합 인스턴스 블레이드에서 **위치**를 확인한다. (해당 위치는 Azure 가상 머신 확장 집합을 배포한 대상 Azure 영역 중 하나여야 한다) 

1. **az10408vmss0 - 인스턴스** 블레이드로 돌아가서 **확장 중**을 클릭한다.

1. **az10408vmss0 - 확장 중** 블레이드에서 **사용자 지정 자동 크기 조정** 옵션을 선택하고 다음 설정을 사용하여 자동확장을 구성한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- |--- |
    | 크기 조정 모드 | **메트릭 기준 크기 조정** | 

1. **+ 규칙 추가** 링크를 클릭하고 **크기 조정 규칙** 블레이드에서 다음 설정을 사용하여 자동확장을 구성한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- |--- |
    | 메트릭 원본 | **현재 리소스 (az10480vmss0)** |
    | 시간 집계 | **최대값** |
    | 메트릭 네임스페이스 | **가상 머신 호스트** |
    | 메트릭 이름 | **Network In Total** |
    | 연산자 | **보다 큼** |
    | 크기 조정 작업을 트리거하는 메트릭 임계값 | **10** |
    | 기간(분) | **1** |
    | 시간 조직 통계 | **최대값** |
    | 작업 | **다음을 기준으로 개수 늘이기** |
    | 인스턴스 수 | **1** |
    | 휴지 기간(분) | **5** |

    >**참고**: 이 값의 목적은 대기 시간 지연 없이 가능한 한 빨리 자동 스케일링을 트리거하는 것이기 때문에 이 값은 현실적인 구성을 나타내지 않습니다.

1. **추가**를 클릭하고 **az10408vmss0 - 확장중** 블레이드로 돌아가서 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다) 

    | 설정 | 값 |
    | --- |--- |
    | 인스턴스 제한 최소값 | **1** |
    | 인스턴스 제한 최대값 | **3** |
    | 인스턴스 제한 기본값 | **1** |

1. **저장**을 클릭한다.

1. Azure 포털 오른쪽 위의 아이콘을 클릭하여 **Azure Cloud Shell**을 실행한다.

1. **Bash** 또는 **PowerShell**을 선택하는 프롬프트 창에서 **PowerShell**을 선택한다.  

    >**참고**: **Cloud Shell**을 처음 실행한 경우, **탑재된 스토리지가 없음** 메시지가 표시됩니다. 이 랩에서 사용하고 있는 구독을 선택하고 **스토리지 만들기**를 클릭하십시오. 

1. Cloud Shell 창에서 다음을 실행하여 Azure 가상 머신 확장 집합 **az10408vmss0** 앞단의 로드 밸런서의 공용 IP 주소를 식별한다. 

   ```powershell
   $rgName = 'az104-08-rg02'

   $lbpipName = 'az10408vmss0-ip'

   $pip = (Get-AzPublicIpAddress -ResourceGroupName $rgName -Name $lbpipName).IpAddress
   ```

1. Cloud Shell 창에서 다음을 실행하여 HTTP 요청을 Azure 가상 머신 확장 집합 **az10408vmss0**에 호스팅된 웹 사이트에 전송하는 무한 루프를 시작한다. 

   ```powershell
   while ($true) { Invoke-WebRequest -Uri "http://$pip" }
   ```

1. Cloud Shell 창을 최소화해놓고, **az10408vmss0 - 인스턴스** 블레이드로 돌아가서 인스턴스의 숫자를 모니터링한다.

    >**참고**: 잠시 기다리거나 **새로고침** 하십시오. 

1. 세 번째 인스턴스가 프로비저닝되면 블레이드로 이동하여 **위치**을 확인한다. (이 작업에서 앞서 식별한 처음 두 영역과 달라야 한다)

1. Cloud Shell 창을 닫는다.  

1. **az10408vmss0** 블레이드에서 **디스크**를 클릭하고, **+ 데이터 디스크 추가**를 클릭한다. 다음 설정을 사용해 새 관리 디스크를 연결한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 | 
    | --- | --- |
    | LUN | **0** |
    | 크기 | **32** |
    | 스토리지 계정 형식 | **표준 HDD** |
    | 호스트 캐싱 | **없음** |

1. 변경 사항을 저장하고, **az10408vmss0** 블레이드의 **설정** 섹션에서 **인스턴스**를 클릭한다. 가상머신 확장 집합의 두 인스턴스를 선택하고 **업그레이드**를 클릭한다. 확인 창이 뜨면 **예**를 클릭한다. 

    >**참고**: 이전 단계에서 만든 디스크는 원시 디스크입니다. 사용하기 전에 먼저 파티션을 만들고 파일 시스템을 생성하여 탑재해야 합니다. 이 작업을 수행하려면 Azure 가상 머신 사용자 지정 스크립트 확장 기능을 사용하십시오. 먼저 기존 사용자 지정 스크립트 확장을 제거하십시오.

1. **az10408vmss0** 블레이드의 **설정** 섹션에서 **확장**을 클릭한다. **CustomScriptExtension**를 선택하고 **제거**를 클릭한다.

    >**참고**: 삭제 작업이 완료될 때까지 기다리십시오.

1. Azure 포털 오른쪽 위의 아이콘을 클릭하여 **Azure Cloud Shell**을 실행한다.

1. **Bash** 또는 **PowerShell**을 선택하는 프롬프트 창에서 **PowerShell**을 선택한다.  

1. Cloud Shell 창의 툴바에서 **파일 업로드/다운로드** 아이콘을 클릭한다. 드롭다운 메뉴에서 **업로드**를 클릭하고 **\\Allfiles\\Labs\\08\\az104-08-configure_VMSS_disks.ps1** 파일을 Cloud Shell의 홈 디렉터리에 업로드한다. 

1. Cloud Shell 창에서 다음 명령을 실행하여 스크립트 내용을 표시한다.

   ```powershell
   Set-Location -Path $HOME

   Get-Content -Path ./az104-08-configure_VMSS_disks.ps1
   ```

    >**참고**: 이 스크립트는 연결된 디스크를 구성하는 사용자 지정 스크립트 확장을 설치합니다.

1. Cloud Shell 창에서 다음을 명령으로 스크립트를 실행하고 Azure 가상 머신 확장 집합의 디스크를 구성하십시오.

   ```powershell
   ./az104-08-configure_VMSS_disks.ps1
   ```

1. Cloud Shell 창을 닫는다.

1. **az10408vmss0** 블레이드의 **설정** 섹션에서 **인스턴스**를 클릭한다. 가상머신 확장 집합의 두 인스턴스를 선택하고 **업그레이드**를 클릭한다. 확인 창이 뜨면 **예**를 클릭한다. 


### 리소스 삭제

   >**참고**: 사용하지 않는 새로 생성된 Azure 리소스를 제거하십시오. 사용하지 않는 리소스를 제거해야 예상치 못한 비용이 발생하지 않습니다.

1. Azure 포털에서 **Cloud Shell**의 **PowerShell** 세션을 시작한다.

1. 다음 명령을 실행하여 이 모듈의 실습에서 생성된 모든 리소스 그룹을 나열한다.

   ```powershell
   Get-AzResourceGroup -Name 'az104-08*'
   ```

1. 다음 명령을 실행하여 이 모듈의 실습에서 생성한 모든 리소스 그룹을 삭제한다.

   ```powershell
   Get-AzResourceGroup -Name 'az104-08*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**참고**: 이 명령은 비동기적으로 실행되므로( --nowait 매개 변수로 결정됨) 동일한 PowerShell 세션 내에서 즉시 다른 PowerShell 명령을 실행할 수 있지만, 리소스 그룹이 실제로 제거되기까지는 몇 분 정도 소요됩니다.


### 요약

이 랩에서 우리는

- Azure 포털과 Azure 리소스 매니저 템플릿을 사용하여 가상 머신을 배포했습니다.
- 가상 머신 확장 기능을 이용하여 Azure 가상 머신을 설정했습니다.
- Azure 가상 머신을 위한 컴퓨트와 스토리지를 확장했습니다.
- Azure 포털을 사용하여 Azure 가상 머신 스케일 집합을 배포했습니다.
- 가상 머신 확장 기능을 사용하여 Azure 가상 머신 스케일 집합을 구성했습니다.
- Azure 가상 머신 확장 집합을 위한 컴퓨트와 스토리지를 확장했습니다. (선택 사항)

