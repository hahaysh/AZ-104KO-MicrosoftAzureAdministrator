---
lab:
    title: '06 - 트래픽 관리 구현'
    module: '모듈 06 - 네트워크 트래픽 관리'
---

# 랩 06 - 트래픽 관리 구현


## 랩 시나리오

Consoto는 허브와 스포크 네트워크 토폴로지에서 Azure 가상 머신을 타겟팅하는 네트워크 트래픽 관리를 테스트합니다. 이 테스트는 트래픽이 허브를 통해 흐르도록 하는 사용자 정의 경로에 의존하여 스포크 간의 연결성을 구현하는 것은 물론, 4 계층 및 7 계층 부하 분산 장치를 사용하여 가상 머신에 걸친 트래픽 분배를 포함합니다. 이러한 목적을 위해 Azure 부하 분산 장치(4계층)와 Azure Application Gateway(7계층)를 사용합니다.


## 목표

이 과정에서, 우리는 다음과 같은 실습을 합니다 :

+ 작업 1: 랩 환경 프로비전
+ 작업 2: 허브와 스포크 네트워크 토폴로지 구성
+ 작업 3: 가상 네트워크 피어링의 전이성(Transitivity) 테스트
+ 작업 4: 허브와 스포크 라우팅 구성
+ 작업 5: Azure 부하 분산 장치 구현
+ 작업 6: Azure 애플리케이션 게이트웨이 구현


## 설명

### 작업 1: 랩 환경 프로비전

이 작업에서는 같은 Azure 지역에 네 개의 가상 머신을 배포합니다. 처음 두개는 허브 가상 네트워크에, 나머지 두 가상 머신은 서로 다른 스포크 가상 네트워크에 각각 배치합니다. 

1. [Azure portal](https://portal.azure.com)에 로그인한다.

1. Azure 포털 오른쪽 위의 아이콘을 클릭하여 **Azure Cloud Shell**을 실행한다.

1. **Bash** 또는 **PowerShell**을 선택하는 프롬프트 창에서 **PowerShell**을 선택한다. 

    >**참고**: **Cloud Shell**을 처음 실행한 경우, **탑재된 스토리지가 없음** 메시지가 표시됩니다. 이 랩에서 사용하고 있는 구독을 선택하고 **스토리지 만들기**를 클릭하십시오.

1. Cloud Shell 창의 툴바에서 **파일 업로드/다운로드** 아이콘을 선택한다. 드롭다운 메뉴에서 **업로드**를 클릭하고, **\\Allfiles\\Module_06\\az104-06-vms-template.json**, **\\Allfiles\\Labs\\06\\az104-06-vm-template.json**, **\\Allfiles\\Labs\\06\\az104-06-vm-parameters.json** 을 Cloud Shell의 홈 디렉토리에 업로드한다.

1. Cloud Shell 창에서 다음 명령을 실행하여 첫 번째 가상 네트워크와 가상 머신들을 호스팅할 리소스 그룹을 생성한다. (`[Azure_region]` 부분을 Azure 가상 머신을 배포할 Azure 지역의 이름으로 대체한다) 

   ```powershell
   $location = '[Azure_region]'

   $rgName = 'az104-06-rg01'

   New-AzResourceGroup -Name $rgName -Location $location
   ```

1. Cloud Shell 창에서 다음 명령을 실행하여 업로드한 템플릿과 파라미터 파일로 첫 번째 가상 네트워크를 만들고 한 쌍의 가상 머신을 배포한다. 

   ```powershell
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-06-vms-template.json `
      -TemplateParameterFile $HOME/az104-06-vm-parameters.json `
      -AsJob
   ```

1. Cloud Shell 창에서 다음 명령을 실행하여 두번째 가상 네트워크와 세번째 가상 머신을 배포할 두 번째 리소스 그룹을 생성한다.

   ```powershell
   $rgName = 'az104-06-rg2'

   New-AzResourceGroup -Name $rgName -Location $location
   ```

1. Cloud Shell 창에서 다음 명령을 실행하여 업로드한 템플릿과 파라미터 파일로 두번째 가상 네트워크를 만들고 가상 머신을 배포한다.

   ```powershell
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-06-vm-template.json `
      -TemplateParameterFile $HOME/az104-06-vm-parameters.json `
      -nameSuffix 2 `
      -AsJob
   ```

1. Cloud Shell 창에서 다음 명령을 실행하여 세번째 가상 네트워크와 네번째 가상 머신을 배포할 세번째 리소스 그룹을 생성한다. 

   ```powershell
   $rgName = 'az104-06-rg3'

   New-AzResourceGroup -Name $rgName -Location $location
   ```
1. Cloud Shell 창에서 다음 명령을 실행하여 업로드한 템플릿과 파라미터 파일로 세번째 가상 네트워크를 만들고 가상 머신을 배포한다.

   ```powershell
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-06-vm-template.json `
      -TemplateParameterFile $HOME/az104-06-vm-parameters.json `
      -nameSuffix 3 `
      -AsJob
   ```
    >**참고**: 다음 작업을 시작하기 전에 배포가 끝날 때까지 기다리십시오. 이 작업은 약 5분 소요됩니다. 

    >**참고**: 배포 상태를 확인하려면 이 작업에서 생성했던 리소스 그룹의 속성을 검토하십시오.

1. Cloud Shell 창을 닫는다. 


### 작업 2: 허브와 스포크 네트워크 토폴로지 구성

이 작업에서는 이전 작업에서 배포한 가상 네트워크 사이에 로컬 피어링을 구성하여 허브와 스포크 네트워크 토폴로지를 만듭니다.

1. Azure 포털에서 **가상 네트워크**를 찾아 선택한다.

1. 이전 작업에서 만든 가상 네트워크를 검토한다.

    >**참고**: 세 개의 가상 네트워크를 배포할 때 사용했던 템플릿은 가상 네트워크의 IP 주소 범위가 중첩되지 않는 것을 보장합니다. 

1. 가상 네트워크 목록에서 **az104-06-vnet01**를 클릭한다.

1. **az104-06-vnet01** 가상 네트워크 블레이드에서 **설정** 섹션의 **피어링**에서 **+ 추가**를 클릭한다.

1. 다음 설정을 사용하여 피어링을 추가한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | az104-06-vnet01에서 원격 가상 네트워크(으)로 피어링 이름 | **az104-06-vnet01_to_az104-06-vnet2** |
    | 가상 네트워크 배포 모델 | **Resource manager** |
    | 구독 | 이 랩에서 사용할 Azure 구독의 이름 |
    | 가상 네트워크 | **az104-06-vnet2 (az104-06-rg2)** |
    | az104-06-vnet2에서 az104-06-vnet01(으)로 피어링 이름 | **az104-06-vnet2_to_az104-06-vnet01** |
    | az104-06-vnet01에서 az104-06-vnet2(으)로 가상 네트워크 액세스 허용 | **사용** |
    | az104-06-vnet2에서 az104-06-vnet01(으)로 가상 네트워크 액세스 허용 | **사용** |
    | az104-06-vnet2에서 az104-06-vnet01(으)로 전달되는 트래픽 허용 | **사용 안 함** |
    | az104-06-vnet01에서 az104-06-vnet2(으)로 전달되는 트래픽 허용 | **사용 안 함** |
    | 게이트웨이 전송 설정 구성 | **(체크하지 않음)** |

    >**참고**: 작업이 끝날 때까지 기다리십시오. 

    >**참고**: 이 과정은 두개의 로컬 피어링을 설정합니다. - az104-06-vnet01에서 az104-06-vnet2로 향하는 피어링, az104-06-vnet2에서 az104-06-vnet01로 향하는 피어링

    >**참고**: **전달되는 트래픽 허용**은 스포크 가상 네트워크 사이 라우팅을 구현하기 위하여 사용됩니다. 이 랩의 다른 단계에서 구현할 예정입니다.

1. **az104-06-vnet01** 가상 네트워크 블레이드에서 **설정** 섹션의 **피어링**에서 **+ 추가**를 클릭한다.

1. 다음 설정을 사용하여 피어링을 추가한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | az104-06-vnet01에서 원격 가상 네트워크(으)로 피어링 이름 | **az104-06-vnet01_to_az104-06-vnet3** |
    | 가상 네트워크 배포 모델 | **Resource manager** |
    | 구독 | 이 랩에서 사용할 Azure 구독의 이름 |
    | 가상 네트워크 | **az104-06-vnet3 (az104-06-rg3)** |
    | az104-06-vnet3에서 az104-06-vnet01(으)로 피어링 이름 | **az104-06-vnet3_to_az104-06-vnet01** |
    | az104-06-vnet01에서 az104-06-vnet3(으)로 가상 네트워크 액세스 허용 | **사용** |
    | az104-06-vnet3에서 az104-06-vnet01(으)로 가상 네트워크 액세스 허용 | **사용** |
    | az104-06-vnet3에서 az104-06-vnet01(으)로 전달되는 트래픽 허용 | **사용 안 함** |
    | az104-06-vnet01에서 az104-06-vnet3(으)로 전달되는 트래픽 허용 | **사용 안 함** |
    | 게이트웨이 전송 설정 구성 | **(체크하지 않음)** |

    >**참고**: 이 과정은 두개의 로컬 피어링을 설정합니다. - az104-06-vnet01에서 az104-06-vnet3으로 향하는 피어링, az104-06-vnet3에서 az104-06-vnet01로 향하는 피어링. 이 작업은 허브와 스포크 토폴로지 구현을 완료합니다. (두 개의 스포크 가상 네트워크)

    >**참고**: **전달되는 트래픽 허용**은 스포크 가상 네트워크 사이 라우팅을 구현하기 위하여 사용됩니다. 이 랩의 다른 단계에서 구현할 예정입니다.


### 작업 3: 가상 네트워크 피어링의 전이성(Transitivity) 테스트

이 작업에서는 Networmk Watcher를 사용하여 가상 네트워크 피어링의 전이성을 조사합니다. 

1. Azure 포털에서 **Network Watcher**를 검색하고 선택한다.

1. **Network Watcher** 블레이드에서 지역 목록을 확장하고, 이 랩의 첫번째 작업에서 리소스를 배포한 지역에서 이용 가능한 서비스인지 확인한다. 

1. **Network Watcher** 블레이드에서 **연결 문제 해결**을 찾는다.

1. **Network Watcher - 연결 문제 해결** 블레이드에서 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | 구독 | 이 랩에서 사용하는 구독 |
    | 리소스 그룹 | **az104-06-rg01** |
    | 원본 유형 | **가상 머신** |
    | 가상 머신 | **az104-06-vm0** |
    | 대상 주소 | **수동으로 지정** |
    | URI, FQDN 또는 IPv4 | **10.62.0.4** |
    | 프로토콜 | **TCP** |
    | 대상 포트 | **3389** |

    > **참고**: **10.62.0.4**는 **az104-06-vm2**의 사설 IP 주소를 나타냅니다.

1. **선택**을 클릭하고 연결 확인 결과를 기다린다. **연결 가능** 상태를 확인하고, 네트워크 경로를 검토하여 VM 사이 중간 홉 없이 직접 연결되어 있는 것을 확인한다.

    > **참고**: 허브 가상 네트워크는 첫번째 스포크 가상 네트워크에 직접 피어링됩니다. 

    > **참고**: **az104-06-vm0**에 Network Watcher Agent 가상 머신 확장 설치가 필요하기 때문에 초기 확인 시간은 약 2분 소요됩니다.

1. **Network Watcher - 연결 문제 해결** 블레이드에서 다음 설정을 사용하여 확인을 시작한다. (다른 값은 기본 설정을 사용한다)
    | 설정 | 값 |
    | --- | --- |
    | 구독 | 이 랩에서 사용하는 구독 |
    | 리소스 그룹 | **az104-06-rg01** |
    | 원본 유형 | **가상 머신** |
    | 가상 머신 | **az104-06-vm0** |
    | 대상 주소 | **수동으로 지정** |
    | URI, FQDN 또는 IPv4 | **10.63.0.4** |
    | 프로토콜 | **TCP** |
    | 대상 포트 | **3389** |

    > **참고**: **10.63.0.4**는 **az104-06-vm3**의 사설 IP 주소를 나타냅니다.

1. **선택**을 클릭하고 연결 확인 결과를 기다린다. **연결 가능** 상태를 확인하고, 네트워크 경로를 검토하여 VM 사이 중간 홉 없이 직접 연결되어 있는 것을 확인한다.

    > **참고**: 허브 가상 네트워크는 두번째 스포크 가상 네트워크에 직접 피어링됩니다. 

1. **Network Watcher - 연결 문제 해결** 블레이드에서 다음 설정을 사용하여 확인을 시작한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | 구독 | 이 랩에서 사용하는 구독 |
    | 리소스 그룹 | **az104-06-rg2** |
    | 원본 유형 | **가상 머신** |
    | 가상 머신 | **az104-06-vm2** |
    | 대상 주소 | **수동으로 지정** |
    | URI, FQDN 또는 IPv4 | **10.63.0.4** |
    | 프로토콜 | **TCP** |
    | 대상 포트 | **3389** |

1. **선택**을 클릭하고 연결 확인 결과를 기다린다. **연결할 수 없음** 상태를 확인한다.

    > **참고**: 두 스포크 가상 네트워크는 서로 피어링되지 않았습니다. (가상 네트워크 피어링은 전이성(transitive)이 없습니다)


### 작업 4: 허브와 스포크 라우팅 구성

이 작업에서는 **az104-06-vm0** 가상 머신의 네트워크 인터페이스에서 IP 전달과 운영 체제 내의 라우팅을 활성화하며, 스포크 가상 네트워크에서 사용자 정의 경로를 구성하여 두 스포크 가상 네트워크 간의 라우팅을 구성하고 테스트합니다.

1. Azure 포털에서 **가상 머신**을 찾아 선택한다.

1. **가상 머신** 목록에서 **az104-06-vm0**을 클릭한다.

1. **az104-06-vm0** 가상 머신 블레이드에서 **설정** 섹션의 **네트워킹**을 클릭한다.

1. **네트워크 인터페이스** 라벨 옆의 **az104-06-nic0** 링크를 클릭한다. **az104-06-nic0** 네트워크 인터페이스 블레이드의 **설정** 섹션에서 **IP 구성**을 클릭한다. 

1. **IP 전달**을 **사용**으로 설정하고 저장한다.

   > **참고**: 이 설정은 **az104-06-vm0**가 라우터로 동작하여 두 스포크 가상 네트워크 사이 트래픽을 라우팅합니다. 

   > **참고**: 이제 라우팅을 지원하기 위해 **az104-06-vm0** 가상 머신의 작업 시스템을 구성해야 합니다. 

1. Azure 포털의 **az104-06-vm0** 가상 머신 블레이드로 돌아가 **개요**를 클릭한다.

1. **az104-06-vm0** 블레이드에서 **작업** 섹션의 **실행 명령**을 클릭하고, 명령 목록에서 **RunPowerShellScript**을 클릭한다.

1. **Run Command Script** 블레이드에서 다음 명령을 입력하고 **실행**하여 Remote Access Windows Server role을 설치한다.

   ```powershell
   Install-WindowsFeature RemoteAccess -IncludeManagementTools
   ```

   > **참고**: **스크립트 실행 완료** 확인 메시지를 기다리십시오.

1. **실행 명령 스크립트** 블레이드에서 다음 명령을 **실행**하여 Routing role service를 설치한다.

   ```powershell
   Install-WindowsFeature -Name Routing -IncludeManagementTools -IncludeAllSubFeature

   Install-WindowsFeature -Name "RSAT-RemoteAccess-Powershell"

   Install-RemoteAccess -VpnType RoutingOnly

   Get-NetAdapter | Set-NetIPInterface -Forwarding Enabled
   ```

   > **참고**: **스크립트 실행 완료** 확인 메시지를 기다리십시오.

   > **참고**: 이제 스포크 가상 네트워크에 대한 사용자 정의 경로를 만들고 구성해야 합니다. 

1. Azure 포털에서 **경로 테이블**을 검색하고, **경로 테이블** 블레이드에서 **+ 추가**를 클릭한다.

1. 다음 설정을 사용하여 경로 테이블을 생성한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | 이름 | **az104-06-rt23** |
    | 구독 | 이 랩에서 사용하는 구독의 이름 |
    | 리소스 그룹 | **az104-06-rg2** |
    | 지역 | 가상 네트워크를 만든 Azure 지역의 이름 |
    | 가상 네트워크 게이트웨이 경로 전파 | **사용 안 함** |

   > **참고**: 경로 테이블 생성이 완료될 때까지 기다리십시오. 이 작업은 약 3분 소요됩니다.

1. **경로 테이블** 블레이드에서 **새로 고침**하고 **az104-06-rt23**을 클릭한다.

1. **az104-06-rt23** 경로 테이블 블레이드에서 **경로**를 선택하고 **+ 추가**를 클릭한다.

1. 다음 설정을 사용하여 새로운 경로를 추가한다. (다른 값은 기본 설정을 사용한다) 

    | 설정 | 값 |
    | --- | --- |
    | 경로 이름 | **az104-06-route-vnet2-to-vnet3** |
    | 주소 접두사 | **10.63.0.0/20** |
    | 다음 홉 형식 | **가상 어플라이언스** |
    | 다음 홉 주소 | **10.60.0.4** |

1. **az104-06-rt23** 경로 테이블 블레이드로 돌아가 **서브넷**을 선택하고 **+ 연결**을 클릭한다.

1. 다음 설정을 사용하여 서브넷에 **az104-06-rt23** 경로 테이블을 연결한다.

    | 설정 | 값 |
    | --- | --- |
    | 가상 네트워크 | **az104-06-vnet2** |
    | 서브넷 | **subnet0** |

1. **경로 테이블** 블레이드로 돌아가 **+ 추가**를 클릭한다.

1. 다음 설정을 사용하여 경로 테이블을 생성한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | 이름 | **az104-06-rt32** |
    | 구독 | 이 랩에서 사용하는 구독의 이름 |
    | 리소스 그룹 | **az104-06-rg3** |
    | 지역 | 가상 네트워크를 만든 Azure 지역의 이름 |
    | 가상 네트워크 게이트웨이 경로 전파 | **사용 안 함** |

   > **참고**: 경로 테이블 생성이 완료될 때까지 기다리십시오. 이 작업은 약 3분 소요됩니다. 

1. **경로 테이블** 블레이드에서 **새로 고침**하고 **az104-06-rt32**를 클릭한다.

1. **az104-06-rt32** 경로 테이블 블레이드에서 **경로**를 선택하고 **+ 추가**를 클릭한다.

1. 다음 설정을 사용하여 새로운 경로를 추가한다. (다른 값은 기본 설정을 사용한다) 

    | 설정 | 값 |
    | --- | --- |
    | 경로 이름 | **az104-06-route-vnet3-to-vnet2** |
    | 주소 접두사 | **10.62.0.0/20** |
    | 다음 홉 형식 | **가상 어플라이언스** |
    | 다음 홉 주소 | **10.60.0.4** |

1. **az104-06-rt32** 경로 테이블 블레이드로 돌아가 **서브넷**을 선택하고 **+ 연결**을 클릭한다.

1. 다음 설정을 사용하여 서브넷에 **az104-06-rt32** 경로 테이블을 연결한다.

    | 설정 | 값 |
    | --- | --- |
    | 가상 네트워크 | **az104-06-vnet3** |
    | 서브넷 | **subnet0** |

1. Azure 포털의 **Network Watcher - 연결 문제 해결** 블레이드로 돌아간다.

1. **Network Watcher - 연결 문제 해결** 블레이드에서 다음 설정을 사용하여 확인을 시작한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | 구독 | 이 랩에서 사용하는 구독의 이름 |
    | 리소스 그룹 | **az104-06-rg2** |
    | 원본 유형 | **Virtual machine** |
    | 가상 머신 | **az104-06-vm2** |
    | 대상 주소 | **수동으로 지정** |
    | URI, FQDN 또는 IPv4 | **10.63.0.4** |
    | 프로토콜 | **TCP** |
    | 대상 포트 | **3389** |

1. **선택**을 클릭하고 연결 확인 결과를 기다린다. **연결 가능** 상태를 확인한다. 네트워크 경로를 검토하여 트래픽이 **az104-06-nic0** 네트워크 어댑터에 할당된 **10.60.0.4**를 통해 라우팅되는 것을 확인한다.

    > **참고**: 스포크 가상 네트워크 사이의 트래픽이 라우터 역할을 하는 허브 가상 네트워크에 있는 가상 머신을 통해 라우팅됩니다. 

    > **참고**: **Network Warcher**를 사용하여 네트워크 토폴로지를 확인할 수 있습니다. 


### 작업 5: Azure 부하 분산 장치 구현

이 작업에서는 허브 가상 네트워크에 있는 두 Azure 가상 머신의 앞단에 Azure 부하 분산 장치를 구현합니다. 

1. Azure 포털에서 **부하 분산 장치**를 검색하고 선택한다. **부하 분산 장치** 블레이드에서 **+ 추가**를 클릭한다.

1. 다음 설정을 사용하여 부하 분산 장치를 생성한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | 구독 | 이 랩에서 사용하는 구독의 이름 |
    | 리소스 그룹 | 새로 만들기 **az104-06-rg4** |
    | 이름 | **az104-06-lb4** |
    | 지역 | 이 랩에서 다른 리소스들을 배포한 지역의 이름 |
    | 형식 | **공개** |
    | SKU | **표준** |
    | 공용 IP 주소 | **새로 만들기** |
    | 공용 IP 주소 이름 | **az104-06-pip4** |
    | 가용성 영역 | **영역 중복** |
    | 공용 IPv6 주소 추가 | **아니요** |

    > **참고**: 부하 분산 장치가 프로비전될 때까지 기다리십시오. 이 작업은 약 2분 소요됩니다. 

1. 배포 블레이드에서 **리소스로 이동**을 클릭한다.

1. **az104-06-lb4** 부하 분산 장치 블레이드의 **백 엔드 풀**에서 **+ 추가**를 클릭한다.

1. 다음 설정을 사용하여 백 엔드 풀을 추가한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | 이름 | **az104-06-lb4-be1** |
    | 가상 네트워크 | **az104-06-vnet01** |
    | IP 버전 | **IPv4** |
    | 가상 머신 | **az104-06-vm0** | 
    | 가상 머신 IP 주소 | **ipconfig1 (10.60.0.4)** |
    | 가상 머신 | **az104-06-vm1** |
    | 가상 머신 IP 주소 | **ipconfig1 (10.60.1.4)** |

1. 백 엔드 풀이 추가될 때까지 기다린 후, **상태 프로브**에서 **+ 추가**를 클릭한다.

1. 다음 설정을 사용하여 상태 프로브를 추가한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | 이름 | **az104-06-lb4-hp1** |
    | 프로토콜 | **TCP** |
    | 포트 | **80** |
    | 간격 | **5** |
    | 비정상 임계값 | **2** |

1. 상태 프로브가 만들어질 때까지 기다린 후, **부하 분산 규칙**에서 **+ 추가**를 클릭한다. 

1. 다음 설정을 사용하여 부하 분산 규칙을 생성한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | 이름 | **az104-06-lb4-lbrule1** |
    | IP 버전 | **IPv4** |
    | 프로토콜 | **TCP** |
    | 포트 | **80** |
    | 백 엔드 포트 | **80** |
    | 백 엔드 풀 | **az104-06-lb4-be1** |
    | 상태 프로브 | **az104-06-lb4-hp1** |
    | 세션 지속성 | **None** |
    | 유휴 제한 시간(분) | **4** |
    | TCP 재설정 | **사용 안 함** |
    | 유동 IP (Direct server return) | **사용 안 함** |
    | 암시적 아웃바운드 규칙 만들기 | **예** |

1. 부하 분산 규칙이 만들어질 때까지 기다린 후, **개요**의 **공용 IP 주소**를 클릭한다. 

1. 브라우저 창을 열고 IP 주소로 접속한다. 

1. 브라우저 창에 **Hello World from az104-06-vm0** 또는 **Hello World from az104-06-vm1**의 메시지가 나타난 것을 확인한다.

1. InPrivate 모드를 사용하여 다른 브라우저 창을 열고, 출력된 메시지를 통해 vm이 변경되었는지 확인한다.

    > **참고**: 브라우저 창을 새로고침 하거나 InPrivate 모드를 사용해 브라우저 창을 다시 열어야 합니다. 


### 작업 6: Azure 애플리케이션 게이트웨이 구현

 작업에서는 스포크 가상 네트워크의 두 Azure 가상 머신 앞단에 Azure 애플리케이션 게이트웨이를 구현합니다. 

1. Azure 포털에서 **가상 네트워크**를 찾아 선택한다.

1. **가상 네트워크** 블레이드의 목록에서 **az104-06-vnet01**를 클릭한다.

1. **az104-06-vnet01** 가상 네트워크 블레이드에서 **설정** 섹션의 **서브넷**을 선택하고, **+ 서브넷**을 클릭한다.

1. 다음 설정을 사용하여 서브넷을 추가한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | 이름 | **subnet-appgw** |
    | 주소 범위 (CIDR 블록) | **10.60.3.224/27** |
    | 네트워크 보안 그룹 | **없음** |
    | 경로 테이블 | **없음** |

    > **참고**: 이 서브넷은 나중에 이 작업에서 배포될 Azure Application Gateway 인스턴스에서 사용됩니다. 애플리케이션 게이트웨이는 /27 이상의 전용 서브넷이 필요합니다.

1. Azure 포털에서 **애플리케이션 게이트웨이**를 찾아 선택한다. **애플리케이션 게이트웨이** 블레이드에서 **+ 추가**를 클릭한다.

1. **애플리케이션 게이트웨이 만들기** 블레이드의 **기본 사항** 탭에서 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | 구독 | 이 랩에서 사용하는 구독의 이름 |
    | 리소스 그룹 | 새로 만들기 **az104-06-rg5** |
    | 게이트웨이 이름 | **az104-06-appgw5** |
    | 지역 | 이 랩의 모든 다른 리소스를 배포한 지역의 이름 |
    | 계층 | **표준 V2** |
    | 자동 크기 조정 | **아니요** |
    | 배율 단위 | **1** |
    | 가용성 영역 | **영역 1, 2, 3** |
    | HTTP2 | **사용 안 함** |
    | 가상 네트워크 | **az104-06-vnet01** |
    | 서브넷 | **subnet-appgw** |

1. **다음: 프런트 엔드 >** 를 클릭하고, 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | 프런트 엔드 IP 형식 | **공용** |
    | 방화벽 퍼블릭 IP 주소 | 새로 추가 **az104-06-pip5** |

1. **다음: 백 엔드 >** 를 클릭하고, **+ 백 엔드 풀 추가**를 클릭한다. 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | 이름 | **az104-06-appgw5-be1** |
    | 대상 없이 백 엔드 풀 추가 | **아니요** |
    | 대상 유형 | **IP 주소 또는 FQDN** |
    | 대상 | **10.62.0.4** |
    | 대상 유형 | **IP 주소 또는 FQDN** |
    | 대상 | **10.63.0.4** |

    > **참고**: 대상은 스포크 가상 네트워크에 있는 가상 머신 **az104-06-vm2**와 **az104-06-vm3**의 사설 IP 주소를 나타냅니다.

1. **추가**하고 **다음: 구성 >** 을 클릭한다. **구성** 탭에서 **+ 회람 규칙 추가**를 클릭한다.

1. **회람 규칙 추가** 블레이드의 **수신기** 탭에서 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | 규칙 이름 | **az104-06-appgw5-rl1** |
    | 수신기 이름 | **az104-06-appgw5-rl1l1** |
    | 프런트 엔드 IP | **공용** |
    | 프로토콜 | **HTTP** |
    | 포트 | **80** |
    | 수신기 유형 | **기본** |
    | 오류 페이지 url | **아니요** |

1. **백 엔드 대상** 탭에서 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | 대상 유형 | **백 엔드 풀** |
    | 백 엔드 대상 | **az104-06-appgw5-be1** |

1. **회람 규칙 추가** 블레이드의 **HTTP 설정** 텍스트 박스 아래 **새로 추가**를 클릭하고 다음 설정을 사용한다. (다른 값은 기본 설정을 사용한다)

    | 설정 | 값 |
    | --- | --- |
    | HTTP 설정 이름 | **az104-06-appgw5-http1** |
    | 백 엔드 프로토콜 | **HTTP** |
    | 백 엔드 포트 | **80** |
    | 쿠키 기반 선호도 | **사용 안 함** |
    | 연결 드레이닝 | **사용 안 함** |
    | 요청 시간 제한(초) | **20** |

1. **추가**를 클릭하고, **회람 규칙 추가** 블레이드로 돌아가 **추가**를 클릭한다.

1. **다음: 태그 >**, **다음: 검토 + 만들기 >**, **만들기**를 이어서 클릭한다.

    > **참고**: 애플리케이션 게이트웨이 인스턴스가 만들어질 때까지 기다리십시오. 이 작업은 약 8분 소요됩니다.


1. Azure 포털에서 **애플리케이션 게이트웨이**를 찾아 선택하고, **az104-06-appgw5**를 클릭한다.

1. **az104-06-appgw5** 애플리케이션 게이트웨이 블레이드에서 **Frontend public IP address** 값을 확인한다.

1. 브라우저 창을 열어서 이전 작업에서 확인했던 IP 주소로 접속한다. 

1. 브라우저 창에서 **Hello World from az104-06-vm2** 또는 **Hello World from az104-06-vm3** 메시지가 출력되는 것을 확인한다. 

1. InPrivate 모드를 사용하여 다른 브라우저 창을 열고, 출력된 메시지를 통해 vm이 변경되었는지 확인한다.

    > **참고**: 브라우저 창을 새로고침 하거나 InPrivate 모드를 사용해 브라우저 창을 다시 열어야 합니다. 


    > **참고**: 여러 가상 네트워크에서 가상 머신을 타겟팅하는 것은 일반적인 구성은 아닙니다. 이 랩의 과정은 Application Gateway가 같은 가상 네트워크 내의 가상 머신 간 부하를 분산하는 Azure 부하 분산 장치와는 달리, 여러 가상 네트워크의(다른 Azure 지역 또는 Azure 외부의 엔드포인트도 포함하여) 가상 머신도 타겟팅할 수 있다는 것을 설명하기 위한 것입니다.


### 리소스 삭제

   >**Note**: 사용하지 않는 새로 생성된 Azure 리소스를 제거하십시오. 사용하지 않는 리소스를 제거해야 예상치 못한 비용이 발생하지 않습니다.

1. Azure 포털에서 **Cloud Shell**의 **PowerShell** 세션을 시작한다.

1. 다음 명령을 실행하여 이 모듈의 실습에서 생성된 모든 리소스 그룹을 나열한다.

   ```powershell
   Get-AzResourceGroup -Name 'az104-06*'
   ```

1. 다음 명령을 실행하여 이 모듈의 실습에서 생성한 모든 리소스 그룹을 삭제한다.


   ```powershell
   Get-AzResourceGroup -Name 'az104-06*' | Remove-AzResourceGroup -Force -AsJob
   ```

   >**참고**: 이 명령은 비동기적으로 실행되므로( --nowait 매개 변수로 결정됨) 동일한 Bash 세션 내에서 즉시 다른 Azure CLI 명령을 실행할 수 있지만, 리소스 그룹이 실제로 제거되기까지는 몇 분 정도 소요됩니다.


### 요약

이 랩에서 우리는

- 랩 환경을 프로비전했습니다. 
- 허브와 스포크 네트워크 토폴로지를 구성했습니다.
- 가상 네트워크 피어링의 전이성을 테스트했습니다.
- 허브와 스포크 토폴로지의 라우팅을 구성했습니다.
- 부하 분산 장치를 구현했습니다.
- 애플리케이션 게이트웨이를 구현했습니다.
